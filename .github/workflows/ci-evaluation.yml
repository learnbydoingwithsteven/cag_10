name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run nightly check
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # Job 1: Dependency Installation Check
  dependency-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [
          'app_01_legal_analyzer',
          'app_02_medical_assistant',
          'app_03_code_reviewer',
          'app_04_support_agent',
          'app_05_financial_analyzer',
          'app_06_paper_summarizer',
          'app_07_product_recommender',
          'app_08_educational_tutor',
          'app_09_compliance_checker',
          'app_10_fact_checker'
        ]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
    
    - name: Install and verify Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r shared/requirements.txt
        if [ -f "${{ matrix.app }}/backend/requirements.txt" ]; then
          pip install -r ${{ matrix.app }}/backend/requirements.txt
          echo "✓ Successfully installed Python dependencies for ${{ matrix.app }}"
        fi
    
    - name: Verify backend imports
      run: |
        python -c "import fastapi; import uvicorn; import pydantic; print('✓ Core backend dependencies OK')"

  # Job 2: Security Scanning
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Run Bandit security scan
      continue-on-error: true
      run: |
        pip install bandit
        bandit -r . -f json -o bandit_report.json || true
    
    - name: Run Safety check
      continue-on-error: true
      run: |
        pip install safety
        safety check --json > safety_report.json || true
    
    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit_report.json
          safety_report.json

  # Job 3: Frontend Build Check
  frontend-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: [
          'app_01_legal_analyzer',
          'app_02_medical_assistant',
          'app_03_code_reviewer',
          'app_04_support_agent',
          'app_05_financial_analyzer',
          'app_06_paper_summarizer',
          'app_07_product_recommender',
          'app_08_educational_tutor',
          'app_09_compliance_checker',
          'app_10_fact_checker'
        ]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Check frontend structure
      run: |
        if [ -f "${{ matrix.app }}/frontend/package.json" ]; then
          echo "✓ Found package.json for ${{ matrix.app }}"
          cd ${{ matrix.app }}/frontend
          
          # Install dependencies with npm install (not ci since no package-lock.json)
          npm install
          
          # Try to build if build script exists
          if grep -q '"build"' package.json; then
            npm run build
            echo "✓ Successfully built frontend for ${{ matrix.app }}"
          else
            echo "⚠ No build script found in package.json"
          fi
        else
          echo "⚠ No frontend package.json found for ${{ matrix.app }}"
        fi

  # Job 4: Code Quality Check
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        pip install flake8 black mypy
    
    - name: Run Python linting
      continue-on-error: true
      run: |
        # Run flake8 with relaxed settings
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "✓ Linting check completed"

  # Job 5: Docker Compose Validation
  docker-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validate docker-compose.yml
      run: |
        if [ -f "docker-compose.yml" ]; then
          docker-compose config > /dev/null
          echo "✓ docker-compose.yml is valid"
        else
          echo "⚠ No docker-compose.yml found"
        fi

  # Job 6: Documentation Check
  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check documentation files
      run: |
        files=(
          "README.md"
          "PROJECT_SUMMARY.md"
          "QUICKSTART.md"
          "COMPLETE_IMPLEMENTATION_GUIDE.md"
        )
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✓ Found $file"
          else
            echo "⚠ Missing $file"
          fi
        done

  # Job 7: Deploy to Staging (Placeholder)
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [dependency-check, security, frontend-build, code-quality]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to staging
      run: |
        echo "✓ Ready for staging deployment"
        echo "Add actual deployment commands here"

  # Job 8: Deploy to Production (Placeholder)
  deploy-production:
    runs-on: ubuntu-latest
    needs: [dependency-check, security, frontend-build, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to production
      run: |
        echo "✓ Ready for production deployment"
        echo "Add actual deployment commands here"
